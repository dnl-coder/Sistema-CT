<!--DISEÑO GENERAL DE LA VISTA-->
<section>
 
  <!--LISTADO DE VACACIONES-->
  <section id="listado">

    <!--TITULO DE LA VISTA-->
    <h3 class="h3-responsive titulo">LISTAR VACACIONES PENDIENTES</h3>
    <h4 class="h4-responsive subtitulo" id="nomPers"></h4>

    <!--CONTENIDO PRINCIPAL DE LA VISTA-->
    <table id="tablaListado" class="table table-striped table-bordered" cellspacing="0" width="100%">
      <thead><tr>
          <th>CODIGO</th>
          <th>PERIODO</th>
          <th>DIAS DE VACACIONES</th>
          <th>VACACIONES EFECTUADAS</th>
        </tr></thead>
      <tbody id="cuerpoTabla"></tbody>
    </table>

  </section>

  <!--DATOS DE LAS VACACIONES-->
  <form class="form2">

    <!--DATOS GENERALES-->
    <div class="card">
      <div class="card-body">

        <div class="row justify-content-center">

          <!--TITULO DE LA VISTA-->
          <div class="col-12 col-md-8 text-center">
            <h3 class="h3-responsive titulo">PROGRAMAR VACACIONES</h3>
            <h4 class="h4-responsive subtitulo" id="contratoVigente"></h4>
          </div>

          <div class="w-100"></div>

          <!--IMAGEN DEL PERSONAL-->
          <div class="col-12 col-md-3 col-xl-2 form-group text-center">

            <img id="previewFoto" class="img-thumbnail"><br>

          </div>

          <!--INFORMACION GENERAL DEL PERSONAL-->
          <div class="col-12 col-md-5 col-xl-4 form-group">

            <!--F. INGRESO A LA EMPRESA-->
            <label for="fIngreso">Fecha de Ingreso</label>
            <input readonly type="date" class="form-control" id="fIngreso">

            <!--EMPRESA ASIGNADA-->
            <label for="empresa">Empresa</label>
            <input readonly type="text" class="form-control" id="empresa">

          </div>

        </div>


      </div>
    </div>

    <!--DATOS PERSONALES--> 
    <div class="card">
      <h5 class="card-header h5">Datos Personales</h5>
      <div class="card-body">

        <div class="form-row">

          <!--APELLIDOS-->
          <div class="col-12 col-md form-group">
            <label for="apellidos">Apellidos</label>
            <input readonly type="text" class="form-control" id="apellidos">
          </div>

          <!--NOMBRE-->
          <div class="col-12 col-md form-group">
            <label for="nombre">Nombres</label>
            <input readonly type="text" class="form-control" id="nombre">
          </div>

         <div class="w-100"></div>

          <!--AREA-->
          <div class="col-12 col-md form-group">
            <label for="area">Area</label>
            <input readonly type="text" class="form-control" id="area">
          </div>

          <!--ESPECIALIDAD-->
          <div class="col-12 col-md form-group">
            <label for="especialidad">Especialidad</label>
            <input readonly type="text" class="form-control" id="especialidad">
          </div>

          <div class="w-100"></div>

          <!--TIPO DE HORARIO-->
          <div class="col-12 col-md form-group">
            <label for="tHorario">Tipo de horario</label>
            <input readonly type="text" class="form-control" id="tHorario">
          </div>

          <!--TURNO O GRUPO-->
          <div class="col-12 col-md form-group">
            <label for="turno">Turno o Grupo</label>
            <input readonly type="text" class="form-control" id="turno">
          </div>

        </div>

      </div>
    </div>
    
    <!--DATOS DIAS DE VACACIONES--> 
    <div class="card">
      <h5 class="card-header h5">Control de dias de vacaciones</h5>
      <div class="card-body">

        <div class="form-row">

          <!--DIAS TOTALES-->
          <div class="col-12 col-md form-group">
            <label for="diasTotales">Dias totales</label>
            <input readonly type="text" class="form-control" id="diasTotales">
            <input readonly type="text" hidden class="form-control" id="codigoenviado">
            <input readonly type="text" hidden class="form-control" id="codcontrato">
          </div>

          <!--DIAS EFECTIVOS-->
          <div class="col-12 col-md form-group">
            <label for="diasEfectivos">Dias efectivos</label>
            <input readonly type="text" class="form-control" id="diasEfectivos">
          </div>

          <!--DIAS PROGRAMADOS-->
          <div class="col-12 col-md form-group">
            <label for="diasProgramadas">Dias programados</label>
            <input readonly type="text" class="form-control" id="diasProgramadas">
          </div>

          <!--SALDO-->
          <div class="col-12 col-md form-group">
            <label for="diasSaldo">Saldo</label>
            <input readonly type="text" class="form-control" id="diasSaldo">
          </div>

        </div>

      </div>
    </div>

    <!--HISTORIAL VACACIONES-->   
   <table class="table my-2">
     <thead>
        <tr>
          <th colspan="8">HISTORIAL VACACIONES <button type="button" class="btn btn-titulo2" data-toggle="modal" data-target="#verificarDisponibilidad">AGREGAR</button></th>   
        </tr>
        <tr>
            <th>#</th>
            <th>Fecha Inicio</th>
            <th>Fecha Regreso</th>
            <th>Dias</th>
            <th>Estado</th>
            <th>Obs</th>
            <th>Accion</th>
        </tr>
     </thead>
     <tbody id="historial">
     </tbody>
   </table> 

   <!-- MODAL MENSAJE DE RENOVACION -->
   <div class="modal fade" id="mensajeRenovacion" tabindex="-1" role="dialog" aria-labelledby="mensajeRenovacionTitulo"
      aria-hidden="true">
    <div class="modal-dialog" role="document">

        <div class="modal-content">

          <div class="modal-header principal">
            <h5 class="modal-title white-text font-weight-bold">Mensaje Renovacion</h5>
            <button id="closeModal" type="button" class="close white-text font-weight-bold" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
           ERROR - Por Necesidad de Mercado, no puede superar los 5 años
           ¿Desea Renovar Contrato?
           <div class="text-center">
           <button id="afirmar" data-dismiss="modal">SI</button>
           <button id="afirmar" data-dismiss="modal" aria-label="Close">NO</button>
            </div>
          </div>
        </div>

    </div>
   </div> 

   <!-- MODAL VERIFICAR DISPONIBILIDAD -->
    <div class="modal fade right" id="verificarDisponibilidad" tabindex="-1" role="dialog" aria-labelledby="verificarDisponibilidadTitulo"
      aria-hidden="true">

      <div class="modal-dialog modal-full-height modal-bottom" role="document">

        <div class="modal-content">
          <div class="modal-header py-1 strong">
            <h5 class="modal-title white-text font-weight-bold">Verificar Disponibilidad</h5>
            <button id="closeModal" type="button" class="close white-text font-weight-bold" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
             
             <div class="row">
               <div class="col-12 col-xl-2 form-group">
                  <input class="form-control" type="date" id="Vinicio">
                  <input class="form-control" type="date" id="Vfin">
                  <select class="form-control" id="codigoEstado">
                      <option value='49'>EFECTIVAS</option>
                      <option value='51'>PROGRAMADAS</option>
                  </select>  
                  <input class="form-control" type="text" id="Varea" placeholder="Area">
                  <input class="form-control" type="text" id="Vturno" placeholder="Turno">
                  <input class="btn m-0 py-1 form-control alternative2" id="buscar" type="button" onclick=" validacionFechas()" value="BUSCAR">
                  <hr>
                  <input class="btn m-0 py-1 form-control red" id="disponible" type="button" disabled value="NO DISPONIBLE">
                  <input class="btn m-0 py-1 form-control alternative2" type="button" disabled id="GUARDAR" onclick="verificarCantidadDias()" value="GUARDAR">
               </div>
               <div class="col-12 col-xl-10 form-group">
                   <table id="disponibilidad" class="table table-striped table-bordered" cellspacing="0" width="100%">
                    <thead>
                      <th>Nombre</th>
                      <th>F Inicio</th>
                      <th>F Final</th>
                      <th>Dias</th>
                      <th>Obs.</th>
                      <th>Estado</th>
                    </thead>
                    <tbody id="LlenarDatos"></tbody>
                   </table>
               </div>
             </div>

          </div>
        </div>

      </div>
    </div>

    <!-- MODAL DIAS DE VACACIONES -->
    <div class="modal fade" id="listadoDatosVacaciones" tabindex="-1" role="dialog" aria-labelledby="listadoPersonalTitulo"
    aria-hidden="true">
      <div class="modal-dialog" role="document">
          <div class="modal-content">
           
            <div class="modal-header principal py-1">
              <h5 class="modal-title white-text font-weight-bold">Modificar vacaciones</h5><input id="diasAnteriores" hidden>
              <button id="closeModal" type="button" class="close white-text font-weight-bold" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
               <div class="form-row">

                <!--CODIGO-->
                <div class="col-12 form-group">
                  <label for="mposicion">Codigo</label>
                  <input readonly type="text" class="form-control" id="mposicion">
                </div>

                <!--FECHA INICIO-->
                <div class="col-12 form-group">
                  <label for="mfecha">Fecha Inicio</label>
                  <input type="date" class="form-control" id="mfecha">
                </div>

                <!--DIAS-->
                <div class="col-12 form-group">
                  <label for="mdia">Dias</label>
                  <input type="number" min="0" class="form-control" id="mdia">
                </div>

                <!--OBSERVACIONES-->
                <div class="col-12 form-group">
                  <label for="modelobs">Observaciones</label>
                  <input type="text" class="form-control" id="modelobs">
                </div>

                <!--ESTADO-->
                <div class="col-12 form-group">
                  <label for="mestado">Estado</label>
                  <select id="mestado" class="form-control">
                      <option value='49'>EFECTIVAS</option>
                      <option value='50'>COMPENSADAS</option>
                      <option value='51'>PROGRAMADAS</option>
                  </select>
                </div>
                
                <button class="btn btn-block principal" id="guardarVacaciones" data-dismiss="modal">GUARDAR</button>

              </div>     
            </div>
            
          </div>   
      </div>
    </div>  
<!-- MENSAJE -->
<div class="toast" data-autohide="true" data-delay="9000"><div class="toast-body"></div></div>
  </form>
  
</section>

<!--ARCHIVOS JS DE LA VISTA-->
<script src="http://momentjs.com/downloads/moment.min.js"></script>
<script type="text/javascript">
   
var codigoActualizar="";
var codeDetaContrato="";
var fechaInicioTabla = new Array();
var fechaFinalTabla = new Array();
var Hoy = new Date();

$(".form2").addClass("d-none");   
  
mostrarContratos(personal);

//--MOSTRAR LOS CONTRATOS DEL PERSONAL--
function mostrarContratos(personal){
    
    var titulos="";
    
    titulos+="<th class='th-sm'>CODIGO</th>\
              <th class='th-sm'>PERIODO</th>\
              <th class='th-sm'>DIAS DE VACACIONES</th>\
              <th class='th-sm'>VACACIONES EFECTUADAS</th>";
    $("#tituloColumnas").html(titulos);
    
    var $personal={
        '_personal' : personal    
   }
    
    $.ajax({
        url: '../CT-BackEnd/Controlador/ModMaestros/Controlador_Personal/Controlador_MostrarPersonalContratoVacaciones.php',
        type: 'POST',
        data: $personal,
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Archivos no encontrados");
            }
            else{
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Error no identificado");
            }
        },
        success: function(datos){
            if(datos.response=="0"){
                mostrarMensaje("error",'ERROR: '+datos.message);
            }else{
                var tablaServicios ="";
                for(var i=0; i<datos.length; i++){
                  if(datos[i].VACAPERSEFECTIVAS!=30){
                    tablaServicios+="<tr id='"+'d-'+datos[i].VACAPERSCODIGO+"' onclick='cargarDatos(this.id,personal)'>\
                                <td>"+datos[i].VACAPERSCODIGO+"</td>\
                                <td>Periodo "+datos[i].VACAPERSPERIODO+"</td>\
                                <td>"+datos[i].VACAPERSDIAS+"</td>\
                                <td>"+datos[i].VACAPERSEFECTIVAS+"</td>\
                                </tr>";
                  }else{
                    tablaServicios+="<tr id='"+'d-'+datos[i].VACAPERSCODIGO+"' onclick='cargarDatos(this.id,personal)'>\
                                <td class='formulario font-weight-bold subform-text'>"+datos[i].VACAPERSCODIGO+"</td>\
                                <td class='formulario font-weight-bold subform-text'>Periodo "+datos[i].VACAPERSPERIODO+"</td>\
                                <td class='formulario font-weight-bold subform-text'>"+datos[i].VACAPERSDIAS+"</td>\
                                <td class='formulario font-weight-bold subform-text'>"+datos[i].VACAPERSEFECTIVAS+"</td>\
                                </tr>";
                  }
                }
                $("#cuerpoTabla").html(tablaServicios);
                $("#nomPers").text(datos[0].PERSAPELLIDO_PATERNO+" "+datos[0].PERSAPELLIDO_MATERNO+" "+datos[0].PERSNOMBRE);
                
            }
        }
    });
}
    
//--CARGAR DATOS DEL PERSONAL--
function cargarDatos(codigo,personal){
    
    $("#listado").addClass("d-none");
    $(".form2").removeClass("d-none");
    codigo = codigo.substr(2);
    var $personal={
        '_personal' : personal    
   }
    $.ajax({
        url: '../CT-BackEnd/Controlador/ModMaestros/Controlador_Personal/Controlador_MostrarPersonalContratoVacaciones.php',
        type: 'POST',
        data: $personal,
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Archivos no encontrados");
            }
            else{
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Error no identificado");
            }
        },
        success: function(datos){
            if(datos.response=="0"){
                mostrarMensaje("error",'ERROR: '+datos.message);
            }else{
                mostrarMensaje("exito",'INFORMACION CARGADA EXITOSAMENTE');
                var dias;
               $("#nombre").val(datos[0].PERSNOMBRE);
               $("#apellidos").val(datos[0].PERSAPELLIDO_PATERNO + " " +datos[0].PERSAPELLIDO_MATERNO);
               $("#empresa").val(datos[0].EMPCODIGO);
               $("#area").val(datos[0].AREADESCRIPCION);
               $("#turno").val(datos[0].PERSTURNO);
               $("#especialidad").val(datos[0].PERSESPECIALIDAD);
               $("#tHorario").val(datos[0].PERSTIPHORARIO);
               $("#fIngreso").val(datos[0].PERSFECHA_INGRESO);
              
               if(datos[0].PERSFOTO!=""){
                  document.getElementById('previewFoto').src = datos[0].PERSFOTO;
               }
              
               $("#Varea").val(datos[0].AREADESCRIPCION);
               $("#Vturno").val(datos[0].PERSTURNO);
                for (var i=0;i<datos.length;i++) {
                    if (codigo ==  datos[i].VACAPERSCODIGO){
                        $("#contratoVigente").html("Periodo "+datos[i].VACAPERSPERIODO);
                        dias=datos[i].VACAPERSDIAS;
                    }
                }
              
                $("#codigoenviado").val(codigo);

                codigoActualizar=codigo;

                cargarVacaciones(codigo,dias);
            }
        }
    });
}     
  
//--CARGAR LOS DETALLES VACACIONES--
function cargarVacaciones(contrato,dias){
    var total,cambio="NO";
    var $personal={
        '_personal' : contrato    
   }
    $.ajax({
        url: '../CT-BackEnd/Controlador/ModMaestros/Controlador_Personal/Controlador_MostrarPersonalVacaciones.php',
        type: 'POST',
        data: $personal,
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Archivos no encontrados");
            }
            else{
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Error no identificado");
            }
        },
        success: function(datos){
            var diastotales =dias;
            var diasefectivos=0, diasprogramados=0, codnumero=0; 
            var tablavacas="";
          
            if(datos.response=="0"){
                var cod = $("#codigoenviado").val();
                crearCodigoDetalleVacaciones(contrato);
              
                $("#diasTotales").val(diastotales);
                $("#diasEfectivos").val(diasefectivos);
                $("#diasProgramadas").val(diasprogramados);
                $("#diasSaldo").val(parseInt(diastotales)-parseInt(diasefectivos)-parseInt(diasprogramados));
                $("#historial").html(tablavacas);
                
            }else{
                var estado;
                for (var i=0;i<datos.length;i++){
                    var diaEvaluar = (vPersonal.calculoFechaFinalxDias(datos[i].DETVACAPERSINICIO,datos[i].DETVACAPERSDIAS)).split("-");
                    var Fechafinal = new Date(parseInt(diaEvaluar[0]),parseInt(diaEvaluar[1]-1),parseInt(diaEvaluar[2]));
                    if(Fechafinal<=Hoy && datos[i].ESTCODIGO==51){
                        estado="EFECTIVAS"; 
                        total=parseInt(datos[i].VACAEFECTIVAS)+parseInt(datos[i].DETVACAPERSDIAS);
                        actualizarEstado(datos[i].DETVACAPERSCODIGO,49);
                        actualizarDiasVacaciones(datos[i].VACAPERSCODIGO,total);
                        diasefectivos=diasefectivos+parseInt(datos[i].DETVACAPERSDIAS);
                        cambio="SI";
                    }else{
                        estado=datos[i].ESTDESCRIPCION;
                    }
                    
                    fechaInicioTabla[i]=datos[i].DETVACAPERSINICIO;
                    fechaFinalTabla[i]=vPersonal.calculoFechaFinalxDias(datos[i].DETVACAPERSINICIO,datos[i].DETVACAPERSDIAS);
                    
                    tablavacas+="<tr>\
                                    <td  class='text-center'>"+(i+1)+"</td>\
                                    <td  class='text-center'>"+datos[i].DETVACAPERSINICIO+"</td>\
                                    <td  class='text-center'>"+vPersonal.calculoFechaFinalxDias(datos[i].DETVACAPERSINICIO,datos[i].DETVACAPERSDIAS)+"</td>\
                                    <td  class='text-center'>"+datos[i].DETVACAPERSDIAS+"</td>\
                                    <td  class='text-center'>"+estado+"</td>\
                                    <td  class='text-center' style='max-width:300px;'>"+datos[i].DETVACAPERSOBS+"</td>\
                                    <td  class='text-center'><input id="+'x-'+ datos[i].DETVACAPERSCODIGO+" type='button' class='btn py-0 px-3 red' value='X' onclick='eliminarvacaciones(this.id)'><input id="+'e-'+ datos[i].DETVACAPERSCODIGO+" type='button' class='btn py-0 px-3 green' data-toggle='modal' data-target='#listadoDatosVacaciones' value='i' onclick='editarvacaciones(this.id)'></td>\
                                    </tr>";
         
                    if(datos[i].ESTCODIGO==49){
                        diasefectivos = diasefectivos + parseInt(datos[i].DETVACAPERSDIAS);
                    }
                    if(datos[i].ESTCODIGO==51 && cambio=="NO"){
                        diasprogramados = diasprogramados + parseInt(datos[i].DETVACAPERSDIAS);
                    }
                    
                }
                $("#diasTotales").val(diastotales);
                $("#diasEfectivos").val(diasefectivos);
                $("#diasProgramadas").val(diasprogramados);
                $("#diasSaldo").val(parseInt(diastotales)-parseInt(diasefectivos)-parseInt(diasprogramados));
                $("#historial").html(tablavacas);                
                
                for (var i=0; i<datos.length; i++){
                    evaluar=(datos[i].DETVACAPERSCODIGO).split("-",2)
                    if(i==0){
                        mayor=parseInt(evaluar[1]);
                    }else{
                        if(mayor<parseInt(evaluar[1])){
                            mayor=parseInt(evaluar[1]);
                        }
                    }
                }
                $("#codcontrato").val(datos[0].VACAPERSCODIGO+"-"+(mayor+1));
                

            }
            actualizarDiasVacaciones( $("#codigoenviado").val(),$("#diasEfectivos").val())
        }
    });
}     
    
//--VALIDACION--
function validacionFechas(){
    if($("#Vinicio").val()=="" || $("#Vfin").val()==""){
        mostrar("advertencia","COMPLETAR CAMPOS DE FECHA");
        $("#Vinicio").focus();
        $("#Vfin").focus();
    }else{
        buscarDisponibilidad(personal);
    }
}    
    
//--BUSCAR DISPONIBILIDAD--
function buscarDisponibilidad(personal){
    
    var finicio = moment($("#Vinicio").val());
    var ffin= moment($("#Vfin").val());
    var area= $("#Varea").val();
    var turno= $("#Vturno").val(); 
   
    $.ajax({
        url: '../CT-BackEnd/Controlador/ModMaestros/Controlador_Personal/Controlador_MostrarDetallesTotalVacaciones.php',
        type: 'GET',
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Archivos no encontrados");
            }
            else{
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Error no identificado");
            }
        },
        success: function(datos){
            if(datos.response=="0"){
                document.getElementById('GUARDAR').disabled = false; 
                  $("#disponible").removeClass("red");
                  $("#disponible").addClass("green"); 
                  $("#disponible").val("DISPONIBLE"); 
                  document.getElementById('disponible').disabled = false;    
                  var tabladatos="";
                  var fechainicial= moment($("#Vinicio").val());
                  var fechafinal = moment($("#Vfin").val());
                  var dias= fechafinal.diff(fechainicial, 'days') +1;
                
                  tabladatos+="<tr>\
                            <td id='vdnombre ' class='text-center'>"+$("#apellidos").val()+"<br>"+$("#nombre").val()+"</td>\
                            <td id='vdfinicio ' class='text-center'>"+$("#Vinicio").val()+"</td>\
                            <td id='vdffin ' class='text-center'>"+$("#Vfin").val()+"</td>\
                            <td id='vddias ' class='text-center'>"+dias+"</td>\
                            <td id='vdobservacion ' class='text-center'><input type='text' class='form-control' id='observacion'></td>\
                            <td id='vdtipo ' class='text-center'>"+$("#codigoEstado").text()+"</td>\
                            </tr>";
                  $("#LlenarDatos").html(tabladatos); 
            }else{
                var tabladisponibles="";
                var fechainicial= moment($("#Vinicio").val());
                var fechafinal = moment($("#Vfin").val());
                var dias= fechafinal.diff(fechainicial, 'days')+1;
                
                if(vPersonal.cambioFechaDate($("#Vinicio").val())<=vPersonal.cambioFechaDate($("#Vfin").val())){
                    if(vPersonal.comparacionFechas(fechaInicioTabla,fechaFinalTabla,$("#Vinicio").val(),$("#Vfin").val())==true){
                        for(var i=0;i<datos.length;i++){
                            //SI ES EFECTIVAS QUE MUESTRE SIN FILTROS
                            if ( $("#codigoEstado").val()==49){
                                if(vPersonal.cambioFechaDate($("#Vinicio").val())<Hoy && vPersonal.cambioFechaDate($("#Vfin").val())<Hoy){
                                    tabladisponibles+="<tr class='text-white green font-weight-bold'>\
                                            <td id='vdnombre' class='text-center'>"+$("#apellidos").val()+"<br>"+$("#nombre").val()+"</td>\
                                            <td id='vdfinicio ' class='text-center'>"+$("#Vinicio").val()+"</td>\
                                            <td id='vdffin ' class='text-center'>"+$("#Vfin").val()+"</td>\
                                            <td id='vddias ' class='text-center'>"+dias+"</td>\
                                            <td id='vdobservacion ' class='text-center'><input type='text' class='form-control' id='observacion'></td>\
                                            <td id='vdtipo ' class='text-center'>EFECTIVA</td>\
                                            </tr>";
                                    i=datos.length;
                                    document.getElementById('GUARDAR').disabled = false; 
                                    $("#disponible").removeClass("red");
                                    $("#disponible").addClass("green"); 
                                    $("#disponible").val("DISPONIBLE"); 
                                    document.getElementById('disponible').disabled = false;

                                }else{
                                     alert("ESTAS FECHAS NO PUEDEN SER EFECTIVAS, CAMBIAR A PROGRAMADAS");
                                     break;
                                }        
                            }
                            else //SI ES PROGRAMADAS QUE MUESTRE CON FILTROS
                            { 
                                if (personal != datos[i].PERSCODIGO){
                                    if (area == datos[i].AREADESCRIPCION){
                                        console.log(area,datos[i].AREADESCRIPCION)
                                        if (turno == datos[i].PERSTURNO ){
                                            var f1 = moment(datos[i].DETVACAPERSINICIO);
                                            var dif1 = f1.diff(finicio, 'days') ;
                                            var dif2 = ffin.diff(f1, 'days');
                                            if(dif1>=0 && dif2>=0){
                                                tabladisponibles+="<tr class='text-white red font-weight-bold'>\
                                                                    <td id='vdnombre ' class='text-center'>"+datos[i].PERSAPELLIDO_PATERNO+" "+datos[i].PERSAPELLIDO_MATERNO+"<br>"+datos[i].PERSNOMBRE+"</td>\
                                                                    <td id='vdfinicio ' class='text-center'>"+datos[i].DETVACAPERSINICIO+"</td>\
                                                                    <td id='vdffin ' class='text-center'>"+vPersonal.calculoFechaFinalxDias(datos[i].DETVACAPERSINICIO,datos[i].DETVACAPERSDIAS)+"</td>\
                                                                    <td id='vddias ' class='text-center'>"+datos[i].DETVACAPERSDIAS+"</td>\
                                                                    <td id='vdobservacion ' class='text-center'>"+datos[i].DETVACAPERSOBS+"</td>\
                                                                    <td id='vdtipo ' class='text-center'>"+datos[i].ESTDESCRIPCION +"</td>\
                                                                   </tr>";
                                            }
                                        }
                                    }   
                                }
                                if ( (i== parseInt(datos.length) -1) && (tabladisponibles=="")){
                                    document.getElementById('GUARDAR').disabled = false; 
                                    $("#disponible").removeClass("red");
                                    $("#disponible").addClass("green"); 
                                    $("#disponible").val("DISPONIBLE"); 
                                    document.getElementById('disponible').disabled = false;
                                   tabladisponibles+="<tr class='text-white green font-weight-bold'>\
                                            <td id='vdnombre' class='text-center'>"+$("#apellidos").val()+"<br>"+$("#nombre").val()+"</td>\
                                            <td id='vdfinicio ' class='text-center'>"+$("#Vinicio").val()+"</td>\
                                            <td id='vdffin ' class='text-center'>"+$("#Vfin").val()+"</td>\
                                            <td id='vddias ' class='text-center'>"+dias+"</td>\
                                            <td id='vdobservacion ' class='text-center'><input type='text' class='form-control' id='observacion'></td>\
                                            <td id='vdtipo ' class='text-center'>PROGRAMADA</td>\
                                            </tr>";
                                   $("#LlenarDatos").html(tabladisponibles); 

                               }else{
                                  $("#disponible").removeClass("green"); 
                                  $("#disponible").addClass("red");  
                                  $("#disponible").val("NO DISPONIBLE");
                                  document.getElementById('GUARDAR').disabled = true; 
                                  document.getElementById('disponible').disabled = false; 
                               }
                            }     
                        }
                 }else{
                    alert("Las fechas solicitadas coinciden con fechas ya registradas. Por favor ingresar otras fechas.")
                }                     
                }else{
                    alert("Fechas Ingresadas no Correctas. Verificar dia, mes y año")
                }
                
                  
                    
                $("#LlenarDatos").html(tabladisponibles);   
            }
        }
    });   
  
}   
   
    
//--ELIMINAR VACACIONES--
function eliminarvacaciones(codigo){
    codigo = codigo.substr(2);
    var $codigo={
        '_codigo' : codigo,   
   }
    
    var cod = $("#codigoenviado").val();
    
    $.ajax({
        url: '../CT-BackEnd/Controlador/ModMaestros/Controlador_Personal/Controlador_EliminarDetalleVacacionesPersonal.php',
        type: 'POST',
        data: $codigo,
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                mostrarMensaje("error","ERROR AL GUARDAR LOS DATOS! Archivos no encontrados");
            }
            else{
               mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Error no identificado");
            }
        },
        success: function(datos){
            if(datos.response=="0"){
                mostrarMensaje("error",'ERROR: '+datos.message);
            }else{
               cargarDatos('d-'+cod,personal);
               $("#resultado").text("REGISTRO ELIMINADO");

            }
        }
    });     

} 
 
//--VERIFICAR MAXIMO DE DIAS DE VACACIONES--    
function verificarCantidadDias(){
      
    
    var diasCompensados,diasVerificados,diasTotales,diasProgramadas,diasEnviar;
    
    diasVerificados=$("#LlenarDatos td:eq(3)").html();
    
    diasTotales=parseInt(diasVerificados)+parseInt($("#diasEfectivos").val())+parseInt( $("#diasProgramadas").val() );
    
    if(diasVerificados>0){
        
        if(diasTotales> parseInt( $("#diasTotales").val()) ){
            mostrarMensaje("advertencia","Se esta excediendo los dias de vacaciones permitidos por contrato")
        }else{
            guardarVacaciones();
            if($("#LlenarDatos select:eq(0)").val()==49){
                diasEnviar= parseInt(diasVerificados)+parseInt($("#diasEfectivos").val());
                actualizarDiasVacaciones(codigoActualizar,diasEnviar);
            }
        }
        
    }else{
        alert("error","ERROR - Dias pedidos son incorrectos");
    }
    
        
}
    
//--GUARDAR VACACIONES DEL PERSONAL--       
function guardarVacaciones(){
    var estado=0;
    var contrato = $("#codcontrato").val().split("-", 2);
    var codigo = $("#codigoenviado").val();
    if ($("#LlenarDatos td:eq(5)").html()=="EFECTIVA"){
        estado=49;
    }else{
        estado=51;
    }
    
    var $personal={
        '_codigo' : contrato[0],       
        '_codigovaca' :  $("#codcontrato").val(),       
        '_finicio' : $("#LlenarDatos td:eq(1)").html(),    
        '_dias' : $("#LlenarDatos td:eq(3)").html(),    
        '_estado' : estado,    
        '_obs' : $("#observacion").val()  
   }    
   $.ajax({
        url: '../CT-BackEnd/Controlador/ModMaestros/Controlador_Personal/Controlador_GuardarVacaciones.php',
        type: 'POST',
        data: $personal,
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                mostrarMensaje("error","ERROR AL GUARDAR LOS DATOS! Archivos no encontrados");
            }
            else{
                mostrarMensaje("error","ERROR AL GUARDAR LOS DATOS! Error no identificado");
            }
        },
        success: function(datos){
            if(datos.response=="0"){
                mostrarMensaje("error",'ERROR: '+datos.message);
            }else{
                cargarDatos('d-'+codigo,personal);
                document.getElementById('GUARDAR').disabled = true; 
                mostrarMensaje("exito",'INFORMACION GUARDADA EXITOSAMENTE');
                $("#Vinicio").val("");
                $("#Vfin").val("");
                $("#LlenarDatos").html("");
                $("#verificarDisponibilidad").modal("hide");
            }
        }
    });
   
}        
    
//--ACTUALIZAR DIAS DE VACACIONES (MAXIMO 30)--        
function actualizarDiasVacaciones(code,diasTotales){
    
    var $codDetalle={
        '_codigo' : code,
        '_dias' :  diasTotales, 
    }
    
    $.ajax({
        url: '../CT-BackEnd/Controlador/ModMaestros/Controlador_Personal/Controlador_ActualizarDiasVacaciones.php',
        type: 'POST',
        data: $codDetalle,
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                mostrarMensaje("error","ERROR AL GUARDAR LOS DATOS! Archivos no encontrados");
            }
            else{
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Error no identificado");
            }
        },
        success: function(datos){
            if(datos.response=="0"){
                mostrarMensaje("error",'ERROR: '+datos.message);
            }else{
               $("#resultado").text("REGISTRO EFECTUADO");
              
            }
        }
    });
    
    
}    
    
//--CREAR CODIGO DEL DETALLE VACACIONES--    
function crearCodigoDetalleVacaciones(codcontrato){
     
    var $codcontrato={
        '_codcontrato' : codcontrato,     
   }
   
   $.ajax({
        url: '../CT-BackEnd/Controlador/ModMaestros/Controlador_Personal/Controlador_MostrarVacacionesdelContrato.php',
        type: 'POST',
        data: $codcontrato,
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Archivos no encontrados");
            }
            else{
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Error no identificado");
            }
        },
        success: function(datos){
            if(datos.response=="0"){
                mostrarMensaje("error",'ERROR: '+datos.message);
            }else{
             $("#codcontrato").val(datos.VACAPERSCODIGO + "-1");
            }
        }
    }); 
   
} 
    
//--ACTUALIZAR ESTADO DEL DETALLE VACACIONES--      
function actualizarEstado(detcontrato,codeEstado){
    
    var $detcontrato={
        '_detcontrato' : detcontrato,
        '_estado' : codeEstado
    }
    
    $.ajax({
        url: '../CT-BackEnd/Controlador/ModMaestros/Controlador_Personal/Controlador_ActualizarEstadoDetContrato.php',
        type: 'POST',
        data: $detcontrato,
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Archivos no encontrados");
            }
            else{
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Error no identificado");
            }
        },
        success: function(datos){
            if(datos.response=="0"){
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Archivos no encontrados");
            }
        }
    });

}    
  
    
//--EVALUAR CANTIDAD DE DIAS DEL MODAL--
$("#guardarVacaciones").click(function(){
    var diasefectivos = parseInt($("#diasEfectivos").val());
    var diasAnteriores = parseInt($("#diasAnteriores").val());
    var diasCambiados = parseInt($("#mdia").val());
    //console.log(diasefectivos,diasAnteriores,diasCambiados)
    var diafinal=0;
    var copiaInicio = fechaInicioTabla.slice();
    var copiaFinal = fechaFinalTabla.slice();
    diafinal= diasefectivos - diasAnteriores + diasCambiados ;
    var pos = copiaInicio.indexOf(diaSeleccionado);
    copiaInicio.splice(pos, 1);
    copiaFinal.splice(pos, 1);
    var fechaCalcular=vPersonal.calculoFechaFinalxDias($("#mfecha").val(),diasCambiados);
    if(vPersonal.comparacionFechas(copiaInicio,copiaFinal,$("#mfecha").val(),fechaCalcular)==true){
        if(comparaEntrePersonal($("#mfecha").val(),fechaCalcular)==true){
            if (diafinal>30){
                mostrarMensaje("error", "Se esta excediendo los dias de vacaciones permitidos por contrato");
            }else{
                guardarVacacionesModel();
            }
           }else{
               alert("Fechas coinciden con dias ya programadas de otros personal de su misma area y turno");
           }
    }else{
        alert("Las fechas solicitadas coinciden con fechas ya registradas. Por favor ingresar otras fechas.");
    }
    
});
    
    
var diaSeleccionado="";  
//--EDITAR EL CAMPO EN UN MODAL-- 
function editarvacaciones(id){
    id = id.substr(2);
    var contrato =$("#codigoenviado").val();
     var $personal={
        '_personal' : contrato    
   }
    
   $.ajax({
        url: '../CT-BackEnd/Controlador/ModMaestros/Controlador_Personal/Controlador_MostrarPersonalVacaciones.php',
        type: 'POST',
        data: $personal,
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Error no identificado");
            }
            else{
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Error no identificado");
            }
        },
        success: function(datos){
            if(datos.response=="0"){ 
                mostrarMensaje("error",'ERROR: '+datos.message);
            }else{ var obs="";
                for(var i=0;i<datos.length;i++){
                    if (id==datos[i].DETVACAPERSCODIGO){
                        $("#mposicion").val(id);
                        $("#mfecha").val(datos[i].DETVACAPERSINICIO);
                        $("#mdia").val(datos[i].DETVACAPERSDIAS);
                        $("#diasAnteriores").val(datos[i].DETVACAPERSDIAS);
                        $("#modelobs").val(""+datos[i].DETVACAPERSOBS+"");
                        $("#mestado").val(datos[i].ESTCODIGO);
                    }
                }
                
            }
            diaSeleccionado=$("#mfecha").val();
        }
    });
}

//--GUARDAR LOS CAMPO DEL MODAL--
function guardarVacacionesModel(){
    var codigo = $("#codigoenviado").val();
    var $personal={       
        '_codigo' :  $("#mposicion").val(),       
        '_finicio' :$("#mfecha").val(),    
        '_dias' : parseInt($("#mdia").val()),    
        '_estado' : parseInt($("#mestado").val()),    
        '_obs' : $("#modelobs").val() 
   } 
    
   $.ajax({
        url: '../CT-BackEnd/Controlador/ModMaestros/Controlador_Personal/Controlador_ActualizarVacaciones.php',
        type: 'POST',
        data: $personal,
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Error no identificado");
            }
            else{
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Error no identificado");
            }
        },
        success: function(datos){
            if(datos.response=="0"){
                mostrarMensaje("error",'ERROR: '+datos.message);
            }else{
                cargarDatos('d-'+codigo,personal);                
                $("#mposicion").val("");
                $("#mfecha").val("");
                $("#mdia").val("");
                $("#modelobs").val("");
                $("#mestado").val("");
            }
        }
    });
} 
    
var prueba=false;
function comparaEntrePersonal(fechaInicioPersonal,fechaFinalPersonal){
    var areaEvaluar= $("#Varea").val();
    var turnoEvaluar= $("#Vturno").val();  
    var arrayInicio = new Array();
    var arrayFinal = new Array();
    var a=0;
       $.ajax({
        url: '../CT-BackEnd/Controlador/ModMaestros/Controlador_Personal/Controlador_MostrarDetallesTotalVacaciones.php',
        type: 'GET',
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Archivos no encontrados");
            }
            else{
                mostrarMensaje("error","ERROR AL CARGAR LOS DATOS! Error no identificado");
            }
        },
        success: function(datos){
            if(datos.response=="0"){
               mostrarMensaje("error",'ERROR: '+datos.message);
            }else{
                   for(var i=0;i<datos.length;i++){
                       if($("#mestado").val()==51){
                            if (personal != datos[i].PERSCODIGO){
                                if (areaEvaluar == datos[i].AREADESCRIPCION){
                                    if (turnoEvaluar == datos[i].PERSTURNO ){
                                        arrayInicio[a]=datos[i].DETVACAPERSINICIO;
                                        arrayFinal[a]=vPersonal.calculoFechaFinalxDias(datos[i].DETVACAPERSINICIO,$("#mdia").val());
                                    }
                                }   
                            }
                       }
                   }
                prueba= vPersonal.comparacionFechas(arrayInicio,arrayFinal,fechaInicioPersonal,fechaFinalPersonal);
        }
        }
    });   
  
    return prueba
}

</script>
